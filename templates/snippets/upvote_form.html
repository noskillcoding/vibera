<form id="upvote-form" action="/upvote/{{ post.uid }}/" method="post" style="display: inline">
    <small>
        <input hidden name="uid" value="{{ post.uid }}" style="display:none">
        <input hidden name="title" style="display:none">
        {% csrf_token %}
        {% if upvoted %}
        <button
            class="upvote-button upvoted"
            disabled=true
            title="Toasted"
        >
        {% else %}
        <button
            type="submit"
            class="upvote-button"
            title="Toast this post"
        >
        {% endif %}
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <polyline points="17 11 12 6 7 11"></polyline>
                <polyline points="17 18 12 13 7 18"></polyline>
            </svg>
            <small class="upvote-count">{{ post.upvotes }}</small>
        </button>
    </small>        
</form>

<script>
    console.log('Upvote script loaded');
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM ready, looking for upvote form...');
        
        const form = document.querySelector('#upvote-form');
        if (!form) {
            console.error('Upvote form not found!');
            return;
        }
        
        console.log('Upvote form found, attaching event listener');
        
        const button = form.querySelector('button');
        console.log('Button found:', button);
        console.log('Button disabled?', button.disabled);
        console.log('Button type:', button.type);
        
        // Add click listener directly to button
        button.addEventListener('click', (e) => {
            console.log('Direct button click detected!');
            e.preventDefault();
            handleUpvote(form);
        });
        
        // Also listen for form submit
        form.addEventListener('submit', (e) => {
            console.log('Form submit event triggered!');
            e.preventDefault();
            handleUpvote(form);
        });
    });
    
    function handleUpvote(form) {
        console.log('Handling upvote...');
        
        const button = form.querySelector('button');
        const upvoteCount = document.querySelector('.upvote-count');
        
        // Disable button during request
        button.disabled = true;
        button.style.opacity = "0.5";
        
        fetch(form.action, {
            method: form.method,
            body: new FormData(form),
        })
        .then(response => {
            console.log('Upvote response status:', response.status);
            console.log('Upvote response:', response);
            
            if (response.ok) {
                // Success - update UI
                button.style.color = "salmon";
                button.title = "Toasted";
                upvoteCount.innerHTML = `${(parseInt(upvoteCount.innerHTML) + 1)}`;
                console.log('Upvote successful!');
            } else {
                // Server error - revert
                button.disabled = false;
                button.style.opacity = "1";
                console.error('Upvote failed with status:', response.status);
                alert('Upvote failed. Are you logged in?');
            }
        })
        .catch(error => {
            // Network error - revert
            button.disabled = false;
            button.style.opacity = "1";
            console.error('Upvote error:', error);
            alert('Network error. Check console for details.');
        });
    }
</script>