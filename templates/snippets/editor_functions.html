<input type="file" id="file" hidden multiple accept="image/*,video/*,.mp4,.webm,.mkv,.heic,.tiff,.bmp,.svg,.webp,.avif,.ico">

<script>
	const $publishedDate = document.getElementById('published-date');
	const $form = document.querySelector('form');
	const $headerContent = document.getElementById('header_content');
	const $hiddenHeaderContent = document.getElementById('hidden_header_content');
	const $textarea = document.querySelector('textarea')
	const $previewButton = document.getElementById('preview')
	const $uploadButton = document.querySelector('#upload-image')
	
	// Submitting form with header content
	const addHeaderContentToFormAndSubmit = () => {
		syncFormFieldsToHeader();
		$hiddenHeaderContent.value = $headerContent.innerText;
		$form.submit();
	}

	$form.addEventListener('submit', function(e) {
		e.preventDefault();
        addHeaderContentToFormAndSubmit()
    });

	document.addEventListener('keydown', function(event) {
		if ((event.ctrlKey || event.metaKey) && event.keyCode === 83) {
			event.preventDefault();
			addHeaderContentToFormAndSubmit()
		}
	});

	// Handle pasting of HTML into header content
	$headerContent.addEventListener('paste', function(e) {
        e.preventDefault();

        let text = '';

        if (e.clipboardData || e.originalEvent.clipboardData) {
            text = (e.originalEvent || e).clipboardData.getData('text/plain');
        } else if (window.clipboardData) {
            text = window.clipboardData.getData('Text');
        }

        if (document.queryCommandSupported('insertText')) {
            document.execCommand('insertText', false, text);
        } else {
            document.execCommand('paste', false, text);
        }
    });

	$textarea.addEventListener('paste', function(e) {
		const selection = $textarea.value.substring($textarea.selectionStart, $textarea.selectionEnd);
		
		if (selection.length > 0) {
			const pastedText = (e.clipboardData || window.clipboardData).getData('text');
			
			if (isUrl(pastedText)) {
				e.preventDefault();
				
				const linkMarkdown = `[${selection}](${pastedText})`;
				
				if (document.queryCommandSupported('insertText')) {
					document.execCommand('insertText', false, linkMarkdown);
				} else {
					const start = $textarea.selectionStart;
					const end = $textarea.selectionEnd;
					$textarea.value = $textarea.value.substring(0, start) + linkMarkdown + $textarea.value.substring(end);
					// Position cursor after the inserted link
					$textarea.selectionStart = $textarea.selectionEnd = start + linkMarkdown.length;
				}
			}
		}
	});

	function isUrl(string) {
		return string.startsWith('http://') || string.startsWith('https://');
	}

	// Handle saving scroll position
	$textarea.scrollTop = sessionStorage.getItem('textareaY') || 0
	$textarea.addEventListener("scroll", function(event) {
		sessionStorage.setItem('textareaY', $textarea.scrollTop)
	})

	// Preview post
	if ($previewButton) {
		const previewForm = document.createElement('form')
		previewForm.target = "print_popup"
		previewForm.method = "POST"
		previewForm.action = "{% url 'post_preview' id=blog.subdomain %}?type={% if post %}post{% else %}homepage{% endif %}"

		const headerContent = document.createElement("input");
		headerContent.type = "hidden"
		headerContent.name = "header_content"
		previewForm.appendChild(headerContent)
		document.body.appendChild(previewForm)

		const bodyContent = document.createElement("input");
		bodyContent.type = "hidden"
		bodyContent.name = "body_content"
		previewForm.appendChild(bodyContent)
		document.body.appendChild(previewForm)
	
		$previewButton.onclick = event => {
			// Sync form fields to header before preview
			syncFormFieldsToHeader();
			
			window.open('about:blank','print_popup','width=1000,height=800');
			headerContent.value = document.querySelector('#header_content').innerText
			bodyContent.value = document.querySelector('#body_content').value
			previewForm.submit()
		}
	}

	function deletePost() {
		{% if post %}
		if (confirm('Are you sure?')) {
			$form.action = '{% url "post_delete" id=blog.subdomain uid=post.uid %}';
			$form.submit()
		}
		{% else %}
		alert('Delete function not available on this page.');
		{% endif %}
	}

	// Media preview functions (available to all users)
	window.addImageToPreview = function(imageUrl, fileName) {
		console.log('Adding image to preview:', imageUrl, fileName);
		
		// Check if this is a page - if so, insert directly into textarea
		const isPage = document.querySelector('.page-description') !== null;
		if (isPage) {
			console.log('Page detected - inserting media directly into textarea');
			insertMediaToTextarea(imageUrl, fileName);
			return;
		}
		
		const mediaPreview = document.getElementById('media-preview');
		const mediaContainer = document.getElementById('media-container');
		
		if (!mediaPreview || !mediaContainer) {
			console.error('Media preview elements not found');
			throw new Error('Media preview elements not found');
		}
		
		// Show the preview area
		mediaPreview.style.display = 'block';
		
		// Create media item
		const mediaItem = document.createElement('div');
		mediaItem.className = 'media-item';
		mediaItem.setAttribute('data-url', imageUrl);
		mediaItem.style.position = 'relative';
		
		// Check if it's a video file
		const isVideo = imageUrl.toLowerCase().match(/\.(mp4|webm|mkv)$/);
		
		if (isVideo) {
			const video = document.createElement('video');
			video.src = imageUrl;
			video.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 3px; cursor: pointer;';
			video.onclick = () => openMediaOverlay(imageUrl, 'video');
			mediaItem.appendChild(video);
		} else {
			const img = document.createElement('img');
			img.src = imageUrl;
			img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 3px; cursor: pointer;';
			img.loading = 'lazy';
			img.onclick = () => openMediaOverlay(imageUrl, 'image');
			
			// Add error handling for broken images
			img.onerror = function() {
				console.error('Failed to load image:', imageUrl);
				
				// Try the original filename without webp conversion
				if (imageUrl.includes('.webp') && fileName) {
					const originalUrl = imageUrl.replace('.webp', '.' + fileName.split('.').pop().toLowerCase());
					console.log('Trying original format:', originalUrl);
					this.src = originalUrl;
					return;
				}
				
				// Show placeholder
				this.style.backgroundColor = '#f0f0f0';
				this.style.display = 'flex';
				this.style.alignItems = 'center';
				this.style.justifyContent = 'center';
				this.textContent = '🖼️';
				this.style.fontSize = '24px';
			};
			
			img.onload = function() {
				console.log('Image loaded successfully:', imageUrl);
			};
			
			mediaItem.appendChild(img);
		}
		
		// Add remove button
		const removeBtn = document.createElement('button');
		removeBtn.textContent = '×';
		removeBtn.style.cssText = 'position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; cursor: pointer;';
		removeBtn.onclick = () => removeMedia(imageUrl);
		mediaItem.appendChild(removeBtn);
		
		mediaContainer.appendChild(mediaItem);
	}

	window.insertMediaToTextarea = function(mediaUrl, fileName) {
		const position = $textarea.selectionStart || $textarea.value.length;
		const isVideo = mediaUrl.toLowerCase().match(/\.(mp4|webm|mkv)$/);
		const name = fileName || mediaUrl.split('/').pop().split('.')[0];
		
		let markdown;
		if (isVideo) {
			markdown = `<video src="${mediaUrl}" controls style="max-width: 100%;"></video>\n\n`;
		} else {
			markdown = `![${name}](${mediaUrl})\n\n`;
		}
		
		$textarea.value = $textarea.value.substring(0, position) + markdown + $textarea.value.substring(position);
		$textarea.selectionStart = $textarea.selectionEnd = position + markdown.length;
		$textarea.focus();
	}

	window.removeMedia = function(mediaUrl) {
		if (!confirm('Remove this media item?')) return;
		
		// Remove from preview
		const mediaItem = document.querySelector(`[data-url="${mediaUrl}"]`);
		if (mediaItem) {
			mediaItem.remove();
		}
		
		// Hide preview area if no more media
		const mediaContainer = document.getElementById('media-container');
		if (mediaContainer.children.length === 0) {
			document.getElementById('media-preview').style.display = 'none';
		}
		
		// TODO: Remove from post.media_urls (would need backend call)
		// For now, user can manually remove from content
	}

	// Helper functions for adding tags/tools - make them global
	window.addTag = function(tag) {
		console.log('Adding tag:', tag);
		const tagsInput = document.getElementById('tags-input');
		const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
		if (!currentTags.includes(tag)) {
			currentTags.push(tag);
			tagsInput.value = currentTags.join(', ');
		}
	}

	window.addTool = function(tool) {
		console.log('Adding tool:', tool);
		const toolsInput = document.getElementById('tools-input');
		const currentTools = toolsInput.value.split(',').map(t => t.trim()).filter(t => t);
		if (!currentTools.includes(tool)) {
			currentTools.push(tool);
			toolsInput.value = currentTools.join(', ');
		}
	}

	// Sync form fields to header content
	function syncFormFieldsToHeader() {
		const titleInput = document.getElementById('title-input');
		const tagsInput = document.getElementById('tags-input');
		const toolsInput = document.getElementById('tools-input');
		const githubInput = document.getElementById('github-input');
		const commentsCheckbox = document.getElementById('comments-checkbox');
		const shortDescInput = document.getElementById('short-description-input');
		
		// Check if this is a page by looking for the page description element
		const isPage = document.querySelector('.post-form .page-description') !== null || 
		               $headerContent.innerHTML.includes('<b>is_page:</b> true');
		
		// Build header content from scratch to avoid corruption
		let headerParts = [];
		
		// Include title from input field or default
		let title = '';
		if (titleInput && titleInput.value.trim()) {
			title = titleInput.value.trim();
		} else {
			const existingTitle = $headerContent.innerHTML.match(/<b>title:<\/b>\s*([^<]*)/);
			if (existingTitle) {
				title = existingTitle[1].trim();
			}
		}
		headerParts.push(`<b>title:</b> ${title}`);
		
		// For pages, only add title and is_page flag
		if (isPage) {
			headerParts.push(`<b>is_page:</b> true`);
		} else {
			// For posts, add all the project-specific fields
			
			// Add short description if present
			if (shortDescInput && shortDescInput.value.trim()) {
				headerParts.push(`<b>short_description:</b> ${shortDescInput.value.trim()}`);
			}
			
			// Add tags if present
			if (tagsInput && tagsInput.value.trim()) {
				headerParts.push(`<b>tags:</b> ${tagsInput.value.trim()}`);
			}
			
			// Add tools if present
			if (toolsInput && toolsInput.value.trim()) {
				headerParts.push(`<b>tools:</b> ${toolsInput.value.trim()}`);
			}
			
			// Add github_url if present
			if (githubInput && githubInput.value.trim()) {
				headerParts.push(`<b>github_url:</b> ${githubInput.value.trim()}`);
			}
			
			// Add comments_enabled if disabled
			if (commentsCheckbox && !commentsCheckbox.checked) {
				headerParts.push(`<b>comments_enabled:</b> false`);
			}
			
			// Add media URLs from preview area
			const mediaItems = document.querySelectorAll('.media-item');
			const mediaUrls = Array.from(mediaItems).map(item => item.getAttribute('data-url'));
			if (mediaUrls.length > 0) {
				headerParts.push(`<b>media_urls:</b> ${JSON.stringify(mediaUrls)}`);
			}
		}
		
		// Set the complete header content
		$headerContent.innerHTML = headerParts.join('<br>');
		console.log('Synced header content:', $headerContent.innerHTML);
	}

	function updateHeaderField(headerText, fieldName, value) {
		const regex = new RegExp(`<b>${fieldName}:</b>\\s*[^<]*(?:<br>|$)`, 'i');
		const newField = `<b>${fieldName}:</b> ${value}<br>`;
		
		if (regex.test(headerText)) {
			return headerText.replace(regex, newField);
		} else {
			// Add new field before the last line (usually make_discoverable)
			const lastBrIndex = headerText.lastIndexOf('<br>');
			if (lastBrIndex !== -1) {
				return headerText.substring(0, lastBrIndex) + '<br>' + newField + headerText.substring(lastBrIndex);
			} else {
				return headerText + '<br>' + newField;
			}
		}
	}

	function removeHeaderField(headerText, fieldName) {
		const regex = new RegExp(`<b>${fieldName}:</b>\\s*[^<]*<br>`, 'i');
		return headerText.replace(regex, '');
	}

	// Upgraded features
	{% if request.user.settings.upgraded %}
	// Upload images
	const $fileInput = document.getElementById("file");

	$uploadButton.onclick = event => {
		event.preventDefault();
		$fileInput.click();
	}

	$fileInput.addEventListener("change", upload);

	window.addEventListener("dragover", event => {
		event.preventDefault();
	});
	
	window.addEventListener("drop", event => {
		event.preventDefault();
		const files = event.dataTransfer.files;
		if (files.length > 0) {
			uploadNextFile(0, files);
		}
	});

	function upload() {
		const files = $fileInput.files;

		if (!files.length) return;

		uploadNextFile(0, files);
	}

	function uploadNextFile(index, files) {
		if (index >= files.length) return; // No more files to upload
		
		const file = files[index];
		if (!file) return; // Safety check

		if (file.size > 10000000) {
			alert(`File over the 10mb limit. Consider resizing it or uploading it elsewhere.`);
			return;
		}

		const formData = new FormData();
		formData.append("file", file);
		{% if post %}formData.append("post_uid", "{{ post.uid }}");{% endif %}

		const target = "{% url 'upload_image' id=blog.subdomain %}";
		const position = $textarea.selectionStart || 0;
		const placeholder = `![Uploading ${file.name}...]\n`;

		$textarea.value = $textarea.value.substring(0, position) + placeholder + $textarea.value.substring(position);
		const newPosition = position + placeholder.length;

		const xhr = new XMLHttpRequest();
		const eventSource = xhr.upload || xhr;

		xhr.open("POST", target, true);
		xhr.send(formData);

		xhr.onload = function() {
			if (this.status === 200) {
				const response = JSON.parse(this.responseText);
				console.log('Upload response:', response);

				response.forEach(imageUrl => {
					if (!imageUrl.startsWith('Error:')) {
						// Remove placeholder
						const currentText = $textarea.value;
						const start = currentText.indexOf(placeholder);
						if (start !== -1) {
							$textarea.value = currentText.substring(0, start) + currentText.substring(start + placeholder.length);
						}
						
						// Check if this is a page by looking for the page description element
						const isPage = document.querySelector('.page-description') !== null;
						
						if (isPage) {
							// For pages, insert media directly into textarea
							const isVideo = imageUrl.toLowerCase().match(/\.(mp4|webm|mkv)$/);
							const imageName = file.name.split('.')[0];
							let markdown;
							if (isVideo) {
								markdown = `<video src="${imageUrl}" controls style="max-width: 100%;"></video>\n\n`;
							} else {
								markdown = `![${imageName}](${imageUrl})\n\n`;
							}
							$textarea.value = $textarea.value.substring(0, position) + markdown + $textarea.value.substring(position);
							$textarea.selectionStart = $textarea.selectionEnd = position + markdown.length;
						} else {
							// For posts, add image to preview area (with slight delay for upload to complete)
							setTimeout(() => {
								try {
									addImageToPreview(imageUrl, file.name);
								} catch (err) {
								console.error('Error adding image to preview:', err);
								// Fallback: add markdown to textarea
									const imageName = file.name.split('.')[0];
									const markdown = `![${imageName}](${imageUrl})\n`;
									$textarea.value = $textarea.value + markdown;
								}
							}, 1500); // Wait 1.5 seconds for upload to complete
						}
					} else {
						// Handle error in response
						console.error('Upload error:', imageUrl);
						alert('Upload error: ' + imageUrl);
						const currentText = $textarea.value;
						const start = currentText.indexOf(placeholder);
						if (start !== -1) {
							$textarea.value = currentText.substring(0, start) + `![Upload failed: ${imageUrl}]\n` + currentText.substring(start + placeholder.length);
						}
					}
				});

				uploadNextFile(index + 1, files);
			} else {
				// Handle error, replace placeholder with error message
				const currentText = $textarea.value;
				const start = currentText.indexOf(placeholder);
				if (start !== -1) {
					$textarea.value = currentText.substring(0, start) + `![Upload of ${file.name} failed]\n` + currentText.substring(start + placeholder.length);
					$textarea.selectionStart = $textarea.selectionEnd = start + `![Upload of ${file.name} failed]\n`.length;
				}

				uploadNextFile(index + 1, files);
			}
		};
	}
	{% else %}
	$uploadButton.onclick = event => {
	    event.preventDefault()
		if (confirm("You've discovered a Pro feature ʕ•ᴥ•ʔﾉ♡\n\nUpgrade to unlock it and support the Tiny Internet!")) {
	    	window.open('{% url "upgrade" %}')
		}
	}

	{% endif %}
	
	// Character counter for short description
	const shortDescInput = document.getElementById('short-description-input');
	const charCountElement = document.getElementById('char-count');
	
	if (shortDescInput && charCountElement) {
		shortDescInput.addEventListener('input', function() {
			const currentLength = this.value.length;
			charCountElement.textContent = currentLength;
			
			// Change color when approaching limit
			if (currentLength > 90) {
				charCountElement.style.color = '#ff6b6b';
			} else if (currentLength > 75) {
				charCountElement.style.color = '#ffa726';
			} else {
				charCountElement.style.color = '#666';
			}
		});
	}
</script>
