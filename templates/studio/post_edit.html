{% extends 'base.html' %}
{% load custom_tags %}

{% block title %}
{% if post %}
Editing {{ post.title }} | Vibera
{% else %}
New drop | Vibera
{% endif %}
{% endblock %}

{% block custom_styles %}
    {% include 'styles/blog/default.css' %}
    {% include 'styles/dashboard.css' %}
    {{ request.user.settings.dashboard_styles | safe }}
{% endblock %}

{% block content %}

{% if error_messages %}
<p style="color:lightsalmon">
    {% for error_message in error_messages %}
        {{ error_message }}<br>
    {% endfor %}
</p>
{% endif %}
<form method="POST" class="post-form full-width">
    <p class="sticky-controls">
        <button
            onclick="event.preventDefault(); sessionStorage.clear(); window.location = '{% if post.is_page or is_page %}{% url 'pages_edit' id=blog.subdomain %}{% else %}{% url 'posts_edit' id=blog.subdomain %}{% endif %}'"
        >
            &#8592; Back
        </button>
        {% if not post or not post.publish %}
        <button type="submit" onclick="document.getElementById('publish').value = true; syncFormFieldsToHeader();">Publish</button>
        {% endif %}
        
        <button {% if post %}onclick="event.preventDefault(); window.open('{{ blog.dynamic_useful_domain }}/{{ post.slug }}{% if not post.publish %}?token={{ post.token }}{% endif %}');"{% else %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
            {% if post %}
                View{% if not post.publish %} draft{% endif %}
            {% else %}
                View draft
            {% endif %}
        </button>
        {% if post %}
            <button
                style="color: red; float: right;"
                onclick="event.preventDefault(); deletePost();"
            >
                Delete
            </button>
        {% endif %}
        {% if not post or not post.publish %}
        <button type="submit" onclick="document.getElementById('publish').value = false; syncFormFieldsToHeader();">
            Save as draft
        </button>
        {% elif post.publish and not post.is_page %}
        <button type="submit" id="save-as-draft-btn" onclick="document.getElementById('publish').value = false; syncFormFieldsToHeader();" style="opacity: 0.5;" disabled>
            Save as new draft
        </button>
        {% elif post.publish and post.is_page %}
        <button type="submit" id="modify-page-btn" onclick="document.getElementById('publish').value = true; syncFormFieldsToHeader();" style="opacity: 0.5;" disabled>
            Modify page
        </button>
        {% endif %}
    </p>

    <!-- Attributes examples hidden - we now have proper UI form fields below -->
    <!--
    <details style="font-size: 12px; margin-bottom: 10px;">
        <summary>
            Attributes (Examples)
        </summary>
        <p style="opacity: 0.6;">
            These were just examples - use the form fields below instead
        </p>
    </details>
    -->
    
    {% csrf_token %}
    <input type="text" name="publish" id="publish" value="{{ post.publish|lower }}" hidden>
    <div
        id="header_content"
        class="editable"
        contenteditable="true"
        style="position: absolute; left: -9999px; margin-bottom:-1px; border-bottom: 1px solid lightgrey;"
    >
        {% if post %}
        <b>title:</b> {{ post.title }}<br>
        {% if post.short_description %}<b>short_description:</b> {{ post.short_description }}<br>{% endif %}
        <b>link:</b> {{ post.slug }}{% if post.alias %}<br>
        <b>alias:</b> {{ post.alias }}{% endif %}<br>
        <b>published_date:</b> <span id="published-date">{% format_date post.published_date 'Y-m-d H:i' 'en' tz %}</span>{% if post.canonical_url %}<br>
        <b>canonical_url:</b> {{ post.canonical_url }}{% endif %}{% if post.meta_description %}<br>
        <b>meta_description:</b> {{ post.meta_description }}{% endif %}{% if post.meta_image %}<br>
        <b>meta_image:</b> {{ post.meta_image }}{% endif %}{% if post.tags|length > 0 %}<br>
        <b>tags:</b> {{ post.tags|join:", " }}{% endif %}{% if post.tools|length > 0 %}<br>
        <b>tools:</b> {{ post.tools|join:", " }}{% endif %}{% if post.github_url %}<br>
        <b>github_url:</b> {{ post.github_url }}{% endif %}{% if not post.comments_enabled %}<br>
        <b>comments_enabled:</b> {{ post.comments_enabled|lower }}{% endif %}{% if post.is_page %}<br>
        <b>is_page:</b> {{ post.is_page|lower }}{% endif %}{% if post.class_name %}<br>
        <b>class_name:</b> {{ post.class_name }}{% endif %}{% if not post.make_discoverable %}<br>
        <b>make_discoverable:</b> {{ post.make_discoverable|lower }}<br>{% endif %}{% elif template_header %}
        <b>{{ template_header|linebreaksbr }}</b>{% if is_page %}<b>is_page:</b> true{% endif %}{% else %}<b>title:</b> <br>{% if is_page %}<b>is_page:</b> true{% endif %}{% endif %}
    </div>

    <input type="hidden" id="hidden_header_content" name="header_content">

    <p style="margin-bottom: 10px;">
        <a id='upload-image' style="padding: 5px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; text-decoration: none; font-size: 14px;">ðŸ“· Insert Media</a> |
        <a href="{% url 'media_center' id=blog.subdomain %}" target="_blank" style="font-size: 14px;">Media Center</a>
    </p>
    
    {% if post.is_page or is_page %}
        <!-- Page Description -->
        <div class="page-description" style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border: 1px solid #b0d4f1; border-radius: 5px; font-size: 14px;">
            <strong>Pages</strong> are static content for your site like "About", "Contact", or other standalone content. Unlike drops, pages don't appear in discovery feeds and are accessed via navigation menus.
        </div>

        <!-- Page Title Section -->
        <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Page Title</label>
            <input type="text" id="title-input" 
                   placeholder="Enter page title..."
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 16px; box-sizing: border-box;"
                   value="{% if post.title %}{{ post.title }}{% endif %}">
        </div>

        <textarea
            name="body_content"
            id="body_content"
            style="width: 100%; min-height: 400px; padding: 8px; border: 1px solid #ddd; border-radius: 3px; resize: vertical; box-sizing: border-box; font-family: inherit;"
            placeholder="Enter your page content..."
        >{% if post %}{{ post.content }}{% else %}{{ template_body }}{% endif %}</textarea>
    {% else %}
        <!-- Media Preview Section -->
        <div id="media-preview" style="margin-bottom: 15px; {% if not post.media_urls or post.media_urls|length == 0 %}display: none;{% endif %}">
            <div id="media-container" style="display: flex; flex-wrap: wrap; gap: 10px; max-height: 120px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 3px; background: #f9f9f9;">
                {% if post.media_urls %}
                    {% for media_url in post.media_urls %}
                        <div class="media-item" data-url="{{ media_url }}" style="position: relative;">
                            {% if media_url|slice:"-4:" == ".mp4" or media_url|slice:"-5:" == ".webm" or media_url|slice:"-4:" == ".mkv" %}
                                <video src="{{ media_url }}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 3px; cursor: pointer;" onclick="openMediaOverlay('{{ media_url }}', 'video')"></video>
                            {% else %}
                                <img src="{{ media_url }}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 3px; cursor: pointer;" onclick="openMediaOverlay('{{ media_url }}', 'image')" loading="lazy">
                            {% endif %}
                            <button onclick="removeMedia('{{ media_url }}')" style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; cursor: pointer;">Ã—</button>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Drop Title Section -->
        <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Drop Title</label>
            <input type="text" id="title-input" 
                   placeholder="Enter your drop title..."
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 16px; box-sizing: border-box;"
                   value="{% if post.title %}{{ post.title }}{% elif template_data.title %}{{ template_data.title }}{% endif %}">
        </div>

        <!-- Short Description Section -->
        <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Short Description (for discovery feed)</label>
            <input type="text" id="short-description-input" maxlength="100" 
                   placeholder="A brief description (max 100 characters)..."
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box;"
                   value="{% if post.short_description %}{{ post.short_description }}{% elif template_data.short_description %}{{ template_data.short_description }}{% endif %}">
            <div id="char-counter" style="font-size: 12px; color: #666; text-align: right; margin-top: 2px;">
                <span id="char-count">{% if post.short_description %}{{ post.short_description|length }}{% elif template_data.short_description %}{{ template_data.short_description|length }}{% else %}0{% endif %}</span>/100 characters
            </div>
        </div>

        <textarea
            name="body_content"
            id="body_content"
            style="width: 100%; min-height: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 3px; resize: vertical; box-sizing: border-box; font-family: inherit;"
            placeholder="Describe your stuff..."
        >{% if post %}{{ post.content }}{% else %}{{ template_body }}{% endif %}</textarea>
    {% endif %}

    {% if not post.is_page and not is_page %}
        <!-- Project Details Sections -->
        <div style="margin-top: 20px;">
            <!-- Tags Section -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tags</label>
                <input type="text" id="tags-input" placeholder="mobile, crypto, dev tools" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box;"
                       value="{% if post.tags %}{{ post.tags|join:", " }}{% elif template_data.tags %}{{ template_data.tags }}{% endif %}">
                <div id="suggested-tags" style="margin-top: 5px; font-size: 12px; color: #666;">
                    Popular: <span style="cursor: pointer; color: #0066cc;" onclick="addTag('mobile')">mobile</span>, <span style="cursor: pointer; color: #0066cc;" onclick="addTag('crypto')">crypto</span>, <span style="cursor: pointer; color: #0066cc;" onclick="addTag('dev tools')">dev tools</span>{% if popular_tags %}{% for tag, count in popular_tags|slice:":10" %}{% if tag not in 'mobile,crypto,dev tools' %}, <span style="cursor: pointer; color: #0066cc;" onclick="addTag('{{ tag }}')">{{ tag }}</span>{% endif %}{% endfor %}{% endif %}
                </div>
            </div>

            <!-- Tools Section -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Tools Used</label>
                <input type="text" id="tools-input" placeholder="cursor, claude code, GPT5" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box;"
                       value="{% if post.tools %}{{ post.tools|join:", " }}{% elif template_data.tools %}{{ template_data.tools }}{% endif %}">
                <div id="suggested-tools" style="margin-top: 5px; font-size: 12px; color: #666;">
                    Popular: <span style="cursor: pointer; color: #0066cc;" onclick="addTool('cursor')">cursor</span>, <span style="cursor: pointer; color: #0066cc;" onclick="addTool('claude code')">claude code</span>, <span style="cursor: pointer; color: #0066cc;" onclick="addTool('GPT5')">GPT5</span>{% if popular_tools %}{% for tool, count in popular_tools|slice:":10" %}{% if tool not in 'cursor,claude code,GPT5' %}, <span style="cursor: pointer; color: #0066cc;" onclick="addTool('{{ tool }}')">{{ tool }}</span>{% endif %}{% endfor %}{% endif %}
                </div>
            </div>

            <!-- GitHub Section -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">GitHub Repository</label>
                <input type="url" id="github-input" placeholder="https://github.com/username/project" 
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box;"
                       value="{% if post.github_url %}{{ post.github_url }}{% elif template_data.github_url %}{{ template_data.github_url }}{% endif %}">
            </div>

            <!-- Comments Section -->
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; font-weight: bold;">
                    <input type="checkbox" id="comments-checkbox" 
                           style="margin-right: 8px;" 
                           {% if post %}{% if post.comments_enabled != False %}checked{% endif %}{% else %}{% if template_data.comments_enabled == 'false' %}{% else %}checked{% endif %}{% endif %}>
                    Enable comments
                </label>
            </div>
        </div>
    {% endif %}

    <span class="helptext sticky">
        <span>
            <a href='http://docs.lh.co/markdown-cheatsheet/' target='_blank'>Markdown syntax</a>
        </span>
    </span>
</form>

<!-- Media Overlay Modal -->
<div id="mediaOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 1000; cursor: pointer;">
    <div style="position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.7); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="closeMediaOverlay()">Ã—</div>
    <div id="mediaContent" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;"></div>
</div>

<script>
    function openMediaOverlay(url, type) {
        const overlay = document.getElementById('mediaOverlay');
        const content = document.getElementById('mediaContent');
        
        if (type === 'video') {
            content.innerHTML = `<video controls style="max-width: calc(100vw - 40px); max-height: calc(100vh - 40px); width: auto; height: auto;" onclick="event.stopPropagation();"><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video>`;
        } else {
            content.innerHTML = `<img src="${url}" alt="Media" style="max-width: calc(100vw - 40px); max-height: calc(100vh - 40px); width: auto; height: auto; object-fit: contain;" onclick="event.stopPropagation();">`;
        }
        
        overlay.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closeMediaOverlay() {
        const overlay = document.getElementById('mediaOverlay');
        const content = document.getElementById('mediaContent');
        
        // Stop any playing videos
        const videos = content.querySelectorAll('video');
        videos.forEach(video => {
            video.pause();
            video.currentTime = 0;
        });
        
        // Clear content
        content.innerHTML = '';
        
        overlay.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }
    
    // Close overlay on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeMediaOverlay();
        }
    });
    
    // Better click handling - only close on background click, not on media
    document.getElementById('mediaOverlay').addEventListener('click', function(e) {
        if (e.target === this || e.target === document.getElementById('mediaContent')) {
            closeMediaOverlay();
        }
    });
</script>

{% include '../snippets/editor_functions.html' with blog=blog post=post%}
{{ request.user.settings.dashboard_footer | safe }}
{% endblock %}