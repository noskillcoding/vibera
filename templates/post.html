{% extends 'base.html' %}
{% load pygmentify_tags %}
{% load custom_tags %}

{% block page_type %}{% if post.is_page %}page{% else %}post{% endif %} {{ post.class_name }}{% endblock %}

{% block lang %}{{ blog.lang }}{% endblock %}

{% block favicon %}{% include 'snippets/favicon.html' with blog=blog %}{% endblock %}

{% block title %}{{ post.title }} | {{ blog.title }}{% endblock %}

{% block canonical %}<link rel="canonical" href="{{ canonical_url }}">{% endblock %}

{% block seo %}
    {% if not blog.reviewed %}<meta name="robots" content="noindex, nofollow">{% endif %}

    <meta name="{{ blog.subdomain }}" content="look-for-the-bear-necessities">

    {% include 'snippets/seo_tags.html' with site_name=blog.title title=post.title type="article" url=full_path description=meta_description image=meta_image meta_tag=blog.meta_tag %}
    <link rel="alternate" type="application/atom+xml" href="/feed/" title="{{ blog.title }}">
    <link rel="alternate" type="application/rss+xml" href="/feed/?type=rss" title="{{ blog.title }}">
{% endblock %}

{% block imports %}
    {% if blog.user.settings.upgraded %}{{ blog.header_directive | safe }}{% endif %}

    {% if blog.fathom_site_id %}<script src="https://cdn.usefathom.com/script.js" data-site="{{ blog.fathom_site_id }}" defer></script>{% endif %}
    {% if post.contains_code %}<link rel="stylesheet" href="{% pygmentify_css minify='false' %}">{% endif %}
{% endblock %}

{% block custom_styles %}
    {% include 'snippets/styles.html' with blog=blog %}
    .upvote-button {
        padding: 0;
        margin: 0;
        border: 0;
        background-color: inherit;
        color: inherit;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .upvote-button.upvoted {
        color: salmon;
    }
    .upvote-count {
        margin-top: -3px;
    }
{% endblock %}

{% block analytics %}
    {% if blog.analytics_active and not preview %}
    <style>
        body:hover {
            shape-outside: url("/hit/{{ post.uid }}/{% if blog.blank_useful_domain not in request.META.HTTP_REFERER %}?ref={{ request.META.HTTP_REFERER }}{% endif %}");
        }
    </style>
    {% endif %}
{% endblock %}

{% block heading %}{{ blog.title }}{% endblock %}

{% block nav %}{% markdown content=blog.nav blog=blog post=post tz=tz %}{% endblock %}

{% block content %}

    {% if preview %}
        <p style="width:100%;padding:10px;background-color:lightsalmon;color:white;display:flex;justify-content:space-between;line-height:15px;">
            PREVIEW
                {% if error_message %}<span>{{ error_message }}</span>{% endif %}
            <small>
                Close and re-open to refresh
            </small>
        </p>
    {% else %}
        {% if request.user == blog.user %}
            <a href="{% url 'post_edit' id=blog.subdomain uid=post.uid %}" target="_blank" style="position: fixed;right: 0;top: 0;padding: 20px;color: lightgrey;text-decoration: none;font-size: 25px;">✎</a>
        {% endif %}
    {% endif %}

    {% if not post.is_page %}
        <h1>{{ post.title }}</h1>

        <p>
            <i>
                <time datetime="{{ post.published_date|date:'Y-m-d\TH:i\Z' }}">
                    {% format_date post.published_date blog.date_format blog.lang tz %}
                </time>
            </i>
        </p>
        
        <!-- Warning banner for posts with active reports -->
        {% if post.active_reports_count > 0 %}
            <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 10px; margin: 15px 0; display: flex; align-items: center; gap: 8px;">
                <span style="color: #f44336; font-size: 18px;">⚠️</span>
                <span style="color: #d32f2f; font-weight: 500;">
                    This post has been reported as potentially dangerous. 
                    <a href="#reports-section" style="color: #d32f2f; text-decoration: underline;">View reports below</a>.
                </span>
            </div>
        {% endif %}

        <!-- Media Gallery for Drops -->
        {% if post.media_urls %}
            <div class="media-gallery" style="margin: 20px 0; display: flex; flex-wrap: wrap; gap: 10px;">
                {% for media_url in post.media_urls %}
                    {% if media_url %}
                        <!-- Check if it's a video -->
                        {% if '.mp4' in media_url or '.webm' in media_url or '.mkv' in media_url %}
                            <a href="#" onclick="openMediaOverlay('{{ media_url }}', 'video'); return false;" style="text-decoration: none; position: relative; display: inline-block;">
                                <video src="{{ media_url }}" style="display: block; width: 100px; height: 100px; object-fit: cover; object-position: center; border-radius: 8px; border: 1px solid #ddd; margin: 0;" muted preload="metadata"></video>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                                    <span style="color: white; font-size: 12px;">▶️</span>
                                </div>
                                <div style="position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 1px 3px; border-radius: 2px; pointer-events: none;">VIDEO</div>
                            </a>
                        {% else %}
                            <!-- It's an image -->
                            <a href="#" onclick="openMediaOverlay('{{ media_url }}', 'image'); return false;" style="text-decoration: none;">
                                <img src="{{ media_url }}" alt="Project media" style="display: block; width: 100px; height: 100px; object-fit: cover; object-position: center; border-radius: 8px; border: 1px solid #ddd; margin: 0;">
                            </a>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}

    {% markdown content=post.content blog=blog post=post tz=tz %}

    {% if canonical_url != full_path %}
        <p>
            <small>
                <a href="{{ canonical_url }}">View original</a>
            </small>
        </p>
    {% endif %}

    {% if not preview and not post.is_page %}
        <!-- Tags, Tools, and GitHub Section for Drops -->
        <div style="margin: 30px 0; padding: 20px 0; border-top: 1px solid #eee;">
            <!-- Tags -->
            {% if post.tags|length > 0 %}
                <p class="tags" style="margin: 10px 0;">
                    <strong>Tags:</strong>
                    {% for tag in post.tags %}
                        <a href="/{{ blog.blog_path }}/?q={{tag}}">#{{ tag }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
            {% endif %}

            <!-- Tools -->
            {% if post.tools|length > 0 %}
                <p class="tools" style="margin: 10px 0;">
                    <strong>Tools:</strong>
                    {% for tool in post.tools %}
                        <a href="/{{ blog.blog_path }}/?tool={{ tool }}">{{ tool }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
            {% endif %}

            <!-- GitHub Link -->
            {% if post.github_url %}
                <p class="github-link" style="margin: 10px 0;">
                    <strong>GitHub:</strong> <a href="{{ post.github_url }}" target="_blank">{{ post.github_url }}</a>
                </p>
            {% endif %}
        </div>
    {% endif %}

    {% if not preview %}
        <!-- Display dangerous report success/error messages -->
        {% if request.GET.report_added %}
            <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0;">
                Report submitted successfully.
            </div>
        {% endif %}
        
        {% if request.GET.report_deleted %}
            <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0;">
                Report deleted successfully.
            </div>
        {% endif %}
        
        {% if request.GET.error == "missing_report_comment" %}
            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0;">
                Please provide a reason why this post is dangerous.
            </div>
        {% elif request.GET.error == "invalid_report_comment" %}
            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0;">
                Report comment must be between 5 and 100 characters.
            </div>
        {% elif request.GET.error == "already_reported" %}
            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0;">
                You have already reported this post.
            </div>
        {% elif request.GET.error == "report_failed" %}
            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0;">
                There was an error submitting your report. Please try again.
            </div>
        {% endif %}
        {% if post.make_discoverable %}
            {% include 'snippets/upvote_form.html' with post=post upvoted=upvoted %}
        {% endif %}
        
        <!-- Comments Section for Drops (not Pages) -->
        {% if post.comments_enabled and not post.is_page %}
            {% include 'snippets/comments_section.html' with post=post %}
        {% endif %}
        
        <!-- Reports Section -->
        {% if post.make_discoverable %}
            {% include 'snippets/dangerous_report_form.html' with post=post user_has_reported=user_has_reported %}
        {% endif %}
    {% endif %}

    <!-- Media Overlay Modal -->
    <div id="mediaOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 1000; cursor: pointer;">
        <div style="position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.7); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="closeMediaOverlay()">×</div>
        <div id="mediaContent" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;"></div>
    </div>

    <script>
        function openMediaOverlay(url, type) {
            const overlay = document.getElementById('mediaOverlay');
            const content = document.getElementById('mediaContent');
            
            if (type === 'video') {
                content.innerHTML = `<video controls style="max-width: calc(100vw - 40px); max-height: calc(100vh - 40px); width: auto; height: auto;" onclick="event.stopPropagation();"><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video>`;
            } else {
                content.innerHTML = `<img src="${url}" alt="Media" style="max-width: calc(100vw - 40px); max-height: calc(100vh - 40px); width: auto; height: auto; object-fit: contain;" onclick="event.stopPropagation();">`;
            }
            
            overlay.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeMediaOverlay() {
            const overlay = document.getElementById('mediaOverlay');
            const content = document.getElementById('mediaContent');
            
            // Stop any playing videos
            const videos = content.querySelectorAll('video');
            videos.forEach(video => {
                video.pause();
                video.currentTime = 0;
            });
            
            // Clear content
            content.innerHTML = '';
            
            overlay.style.display = 'none';
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        // Close overlay on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMediaOverlay();
            }
        });
        
        // Better click handling - only close on background click, not on media
        document.getElementById('mediaOverlay').addEventListener('click', function(e) {
            if (e.target === this || e.target === document.getElementById('mediaContent')) {
                closeMediaOverlay();
            }
        });
    </script>

{% endblock %}


{% block footer %}
    {% if blog.user.settings.upgraded and blog.footer_directive %}
        <span id="footer-directive">
            {% markdown content=blog.footer_directive blog=blog post=post tz=tz %}
        </span>
    {% endif %}
    <span>
        Powered by <a href="https://vibera.dev">vibera ∞ʕ◎ᴥ◎ʔ∞</a>
    </span>
{% endblock %}